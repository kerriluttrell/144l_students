
---
title: '144L week #4 notes'
author: "Kerri Luttrell"
date: "11/1/2020"
output: github_document
---

```{r setup, include=FALSE}

setwd("~/Github/144l_students")
```

# Intro

This document shows how **individual bottle** TOC/DOC data from ACIDD remineralization experiments were processed, QC'ed , adn analyzed.

```{r, warning= FALSE, message= FALSE}
library (tidyverse)
library(readxl)
library(lubridate)
library(broman)
library(plyr)
```

```{r}
excel_sheets("~/Github/144l_students/Input_Data/week4/144L_2018_Exp_TOC.xlsx")

metadata1 <- read_excel("~/Github/144l_students/Input_Data/week4/144L_2018_Exp_TOC.xlsx", sheet = "Metadata")

data1 <- read_excel("~/Github/144l_students/Input_Data/week4/144L_2018_Exp_TOC.xlsx", sheet= "Data")

```

```{r}
glimpse(metadata1)
#80 rows, 16 columns
```

```{r}
glimpse(data1)
# 32 rows, 6 columns

```
TOC: samples taken directly from bottle incubations
PTOC: samples sacrificially taken from incubation vials (goes beyond duration of bottle samples)

#Prepare Data

```{r warning= F}
joined1 <-  left_join (metadata1, data1)
toc1 <-  joined1 %>%
 mutate(Datetime = ymd_hm(Datetime))%>%
  group_by (Experiment, Bottle)%>%
  mutate ( interv = interval(first(Datetime), Datetime),
                hours = as.numeric(interv)/3600,
                days = hours/24) %>%
  ungroup() %>%
    dplyr::rename(sd_TOC = TOC_sd,
         sd_PTOC = PTOC_sd)%>%
  select(Experiment:Datetime, hours, days, everything(), -c(contains("Sample")))
   glimpse(toc1)

```

```{r}
glimpse(toc1)
#80 rows, 18 columns
```

# PLot the curves

## Pivot data

```{r}
colnames(toc1)
pivot_toc1 <- toc1 %>% 
  select(Experiment, Location, Bottle, Treatment, days, TOC, PTOC) %>%
  pivot_longer(TOC:PTOC, names_to = "sample", values_to = "value")

# used pivot longer to expand number of rows and decrease the number of columns

pivot_toc_sd1 <- toc1 %>%
   select(Experiment, Location, Bottle, Treatment, days, sd_TOC, sd_PTOC) %>%
  pivot_longer(sd_TOC:sd_PTOC, names_to = "sample", names_prefix= "sd_", values_to = "sd")

pivoted1 <- left_join (pivot_toc1,pivot_toc_sd1) %>%
  mutate(sample = ifelse(sample=="TOC", "Bottle", "Vial"))
#this mutate replaced the data input in the column with news names/proxies, whereas rename renames the columns
```

```{r}
custom.colors <- c("Control"= "Cadet Blue", "Ash Leachate"="Perwinkle", "Mud Leachate" = "Wistera", "Glucose_NItrate_Phosphate" = "Orchid", "Vial"= "lightcyan4", "Bottle"= "lightcoral")

levels <- c("Control", "Ash Leachate", "Mud Leachate", "Glucose_Nitrate_Phosphate", "Bottle", "Vial")

pivoted1 %>%
  drop_na (value) %>%
  mutate(Treatment = factor(Treatment, levels = levels), sample = factor(sample, levels = levels))%>%
  ggplot(aes(x =days, y = value, group = interaction(Treatment, Bottle)))+
  geom_errorbar(aes(ymin = value - sd, ymax = value + sd, color = sample), width = 0.4)+
  geom_point(aes(fill = sample ), size = 3, shape = 21, alpha = 0.7)+
  labs (x = "Days", y = expression ("Total Organic Carbon , µmol C L"^-1), colro = "", fill= "") +
  scale_color_manual(values = custom.colors)+
  scale_fill_manual(values= custom.colors)+
  theme_bw()+
  facet_grid(rows = "Treatment", scales = "free")+
  guides (color=F)

```
The analytical detection limit for our TOC analysis is -1.5 µmol C L^-1^. Samoles from bottle and vial taken at same time points in same treatmenet look relativiely similar, although some have a high standarad deviation.

# TOC v PTOC (bottle v vial samples)
we want to make sure that samples taken from bottle and vial at same time point are similar

```{r}

library(lmodel2)
#lmodel2 is used when neither x or y variable are controlled or dependent on each other, both have error surrounding measurements
reg.data1 <- toc1 %>% 
  drop_na(TOC)%>%
  filter(Timepoint >0)
#TOC measurement at initial timepoint is same between bottle and vial so we only care about timepoints greater than 0

reg1 <- lmodel2(PTOC ~TOC, data = reg.data1, nperm =90)
#this places toc values on x axis and ptoc on y axis, n perm stands for number of times the statistical model is run
```
```{r}
reg1
```

```{r}
intercept1 <-  reg1$regression.results[3,2]
slope1 <-  reg1$regression.results[3,3]

two_int1 <- reg1$confidence.intervals[3,2]
two_slope1 <- reg1$confidence.intervals[3,4]
nine_int1 <-  reg1$confidence.intervals[3,3]
nine_slope1 <- reg1$confidence.intervals[3,5]
```

```{r, fig.height=4,fig.width=5}
reg.data1%>%
  ggplot(aes( x = TOC, y = PTOC)) +
  geom_errorbar(aes(ymin = PTOC - sd_PTOC, ymax = PTOC + sd_PTOC), width = 0.05) +
  geom_point(fill = "white", shape = 21, size =4, alpha =0.7) +
  geom_abline(intercept = intercept1, slope = slope1, color = "black", linetype= 2, size = 1)+
  geom_abline(intercept = two_int1, slope= two_slope1, color = "black", linetype = 3 , size = 1)+
    geom_abline(intercept = nine_int1, slope = nine_slope1, color = "black", linetype = 3, size = 1) +
    labs(x = expression ("Bottle TOC, µmol C L"^-1), y = expression ("Vial TPC µmul C L " ^-1))+
    theme_bw()+
    annotate ( geom = "text", label = expression (atop("y= 1.03x - 2.1", paste ("r"^2," =0.92," , italic("p "), "=0.01"))), x= 75, y=78, size=4)
  
```

good linear fit between two parameters but there is about a 28% difference between coressponding measurements when they are different. However this 28% limit is within the detection limit of the methodology (1.5) so they are not significantly different form one another.


```{r}
bc1 <-  read_rds( "~/Github/144l_students/Input_Data/week3/Homework_Processed_BactAbund.rds")
```

```{r}

merge1 <- left_join(toc1, bc1 %>% select(-c( days, hours)))%>%
  select (Experiment:days, TOC:sd_PTOC, cells:diff_ln_cells, bc, ave_bc, sd_bc, everything(), -c(contains("Sample")) ) %>%
  group_by(Experiment, Treatment, Bottle) %>%
  fill(exp_start:sd_lag) %>%
  ungroup()
#deleted the -c(Datetime part of above code that was in tutorial)
glimpse(merge1)

subset <- merge1 %>%
  select(Experiment, Treatment, Bottle, days, PTOC, bc)

#80 roww 46 columns
```


```{r}

library(zoo)
```

We only want to interpolate within an experiment and not across experiments, so we'll perform the interpolation by using the split-apply-combine strategy.

-split the dataframe into a list of its elements
-apply the interpolation function to each of the list elements
-combine the results into a new dataframe

##Split

```{r}
to_interpolate1 <- merge1 %>%
  select(Experiment, Treatment, Bottle, Timepoint, days, PTOC, bc) %>%
  group_by(Treatment, Bottle) # first we'll define the grouping of our dataframe

list <- to_interpolate1 %>%
  group_split() #then we can convert the dataframe into a list, broken up by the groups (list elements)

keys1 <-  to_interpolate1 %>%
  group_keys() %>%
  mutate(key = paste(Treatment, Bottle))

names(list) <- keys1$key
           
```

## Write the function

```{r}
interp.func1 <- function(x) {
  y <-  zoo(x, order.by = x$days) #orders observations
  interp_toc <- round(as.numeric(na.approx(y$PTOC, na.rm = F)), 1) #interpolates toc
  interp_bc <- round(as.numeric(na.approx(y$bc, na.rm = F)), 1)
  z <- cbind(y, interp_toc, interp_bc) #combines the columnes
  as_tibble(z) #convert to dataframe
}
```

## Apply and Combine

```{r}
interpolated1 <- lapply(list, interp.func1) %>%
  plyr::ldply(., as.data.frame) %>%
  select(-c(.id, PTOC, bc, days)) %>%
  mutate_at(vars(Timepoint:interp_bc), as.numeric) %>%
  left_join(merge1, .)


```
```{r}
glimpse(interpolated1)

#80 rows 48 columns
```

# Estimate DOC, Bioavailability, BGEs

```{r}
doc1 <- interpolated1 %>% 
   mutate (doc = interp_toc - interp_bc)%>%
   group_by (Treatment, Bottle) %>% 
  mutate(doc_exp_end = ifelse(Timepoint == exp_end, doc, NA)) %>%
   mutate( delta_doc = first (doc) - doc_exp_end)%>%
  mutate(bioav_doc = (delta_doc/first(doc)))%>%
  mutate(tdelta_doc = first(doc) - last(na.omit(doc))) %>%
  mutate(bge = ifelse(delta_bc > 1.5, delta_bc/delta_doc, NA)) %>%
            fill (doc_exp_end:bge, .direction = "downup") %>%
           ungroup()

subset1 <- doc1 %>% 
  select(Experiment,Treatment, Bottle, Timepoint, exp_end, days,doc, bioav_doc, doc_exp_end, delta_doc, tdelta_doc, bge)

glimpse(doc1)
#80 rows 54 columns 9added 6 columns with mutate function
#no bge values (THIS IS AN ISSUE)
```

# Treatment averages

```{r}
averages1 <-  doc1 %>%
group_by (Experiment, Treatment, Timepoint) %>%
  mutate(ave_toc = mean(PTOC),
         sd_toc = sd(PTOC)) %>%
  ungroup()%>%
  group_by(Experiment, Treatment) %>%
  mutate(ave_bioav_doc = mean (bioav_doc),
         sd_bioav_doc = sd(bioav_doc),
         ave_delta_doc = mean(delta_doc),
         sd_delta_doc = sd(delta_doc),
         ave_tdelta_doc = mean(tdelta_doc),
         sd_tdelta_doc = sd(tdelta_doc),
         ave_bge = mean(bge),
         sd_bge = sd(bge))%>%
  ungroup()

subset <-  averages1 %>%
  select (Experiment, Treatment, Bottle, Timepoint, PTOC, ave_toc:sd_bge)

glimpse(subset)
#80 rows and 15 columns STILL NO BGE
```







